# å¯ç”¨ Qt è‡ªåŠ¨å¤„ç† MOCã€UICã€RCC
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# æŸ¥æ‰¾ Qt6 ç»„ä»¶
find_package(Qt6 REQUIRED COMPONENTS Core Widgets OpenGLWidgets)

# æ”¶é›†æ‰€æœ‰æºæ–‡ä»¶
file(GLOB_RECURSE SANDBOX_SRC_FILES "src/*.cpp")

# ğŸ‘‡ å…³é”®ï¼šæ˜¾å¼åˆ—å‡ºéœ€è¦ MOC çš„å¤´æ–‡ä»¶ï¼ˆç›¸å¯¹äº CMakeLists.txt çš„è·¯å¾„ï¼‰
set(SANDBOX_MOC_HEADERS
    include/sandbox/MainWindow.h
    include/sandbox/MainOpenGLWidget.h
)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(iengine_sandbox ${SANDBOX_SRC_FILES} ${SANDBOX_MOC_HEADERS})

# é“¾æ¥ iengine åº“å’Œ Qt ç»„ä»¶
target_link_libraries(iengine_sandbox 
    iengine
    Qt6::Core
    Qt6::Widgets
    Qt6::Gui
    Qt6::OpenGLWidgets
)

# è®¾ç½®åŒ…å«ç›®å½•
target_include_directories(iengine_sandbox PRIVATE 
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/Engine/include
)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
target_compile_options(iengine_sandbox PRIVATE
    $<$<CXX_COMPILER_ID:MSVC>:/W4>
    $<$<NOT:$<CXX_COMPILER_ID:MSVC>>:-Wall -Wextra>
)

# è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„å±æ€§
set_target_properties(iengine_sandbox PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}
)

# -----------------------------
# Windows: è‡ªåŠ¨å¤åˆ¶ assets & éƒ¨ç½² Qt DLL
# -----------------------------
if(WIN32 AND MSVC)
    if(NOT DEFINED Qt6_DIR)
        message(FATAL_ERROR "Qt6_DIR is not set. Please set CMAKE_PREFIX_PATH or Qt6_DIR")
    endif()

    # # -----------------------------
    # # POST_BUILD: æ‹·è´åˆ°æ„å»ºç›®å½•(VSä¸­å¯åŠ¨çš„æ—¶å€™ï¼Œå·¥ä½œç›®å½•å°±æ˜¯è¿™ä¸ªæ„å»ºç›®å½•)
    # # -----------------------------
    # add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    #     COMMAND ${CMAKE_COMMAND} -E copy_directory
    #         "${CMAKE_SOURCE_DIR}/assets"
    #         "${CMAKE_BINARY_DIR}/assets"
    #     COMMENT "Copying assets to build directory..."
    # )

    # # -----------------------------
    # # POST_BUILD: æ‹·è´åˆ° exe æ‰€åœ¨çš„ç›®å½•
    # # -----------------------------
    # add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
    #     COMMAND ${CMAKE_COMMAND} -E copy_directory
    #         "${CMAKE_SOURCE_DIR}/assets"
    #         "$<TARGET_FILE_DIR:${PROJECT_NAME}>/assets"
    #     COMMENT "Copying assets to exe directory..."
    # )

    # æŸ¥æ‰¾ windeployqt å·¥å…·
    find_program(WINDEPLOYQT_EXECUTABLE windeployqt)

    # ä½¿ç”¨â€œwindeployqtâ€ç¨‹åºæ£€æµ‹å¹¶æ‹·è´éœ€è¦çš„QTåŠ¨æ€åº“åˆ°å¯æ‰§è¡Œç¨‹åºæ‰€åœ¨çš„ç›®å½•
    if(WINDEPLOYQT_EXECUTABLE)
        add_custom_command(TARGET iengine_sandbox POST_BUILD
            COMMAND ${WINDEPLOYQT_EXECUTABLE}
                # $<TARGET_FILE_DIR:iengine_sandbox>  # å¯æ‰§è¡Œæ–‡ä»¶çš„ç›®å½•ï¼ˆå¦‚æœæ˜¯1ä¸ªç›®å½•ï¼Œwindeployqtä¼šæ‰«æè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶å°è¯•ä¸ºå®ƒä»¬éƒ¨ç½² Qt ä¾èµ–é¡¹ï¼‰
                $<TARGET_FILE:iengine_sandbox>       # å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
                --no-compiler-runtime               # ä¸æ‹·è´ç¼–è¯‘å™¨è¿è¡Œæ—¶
                --no-system-d3d-compiler            # ä¸æ‹·è´ç³»ç»Ÿ D3D ç¼–è¯‘å™¨
                --no-translations                   # ç¦ç”¨å¤šè¯­è¨€æ”¯æŒ
            COMMENT "Running windeployqt to copy Qt libraries..."
        )
    endif()
endif()